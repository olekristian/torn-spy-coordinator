<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Torn Spy Coordinator</title>
<style>
  :root{--bg:#0b1320;--card:#111a2b;--muted:#7e8aa0;--text:#e8eefc;--accent:#89b4ff;--good:#3ddc97;--warn:#ffd166;--bad:#ef476f}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:26px;margin:0 0 8px} .sub{color:var(--muted);margin:0 0 16px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 18px}
  input, textarea, button, select{font:inherit}
  input, textarea, select{background:#0e1626;border:1px solid #22314f;color:var(--text);border-radius:10px;padding:10px 12px}
  textarea{width:100%;min-height:140px;resize:vertical}
  button{background:#1b2640;color:#eaf2ff;border:1px solid #2a3a63;padding:10px 14px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#3a5499}
  .tabs{display:flex;gap:6px;margin:0 0 14px}
  .tab{padding:8px 12px;border:1px solid #22314f;border-radius:999px;background:#0e1626;color:#cfe0ff}
  .tab.active{background:#203058;border-color:#3d5591}
  .grid{display:grid;gap:12px}
  @media(min-width:800px){.grid.cards{grid-template-columns:repeat(3,1fr)}}
  .card{background:var(--card);border:1px solid #1a2744;border-radius:16px;box-shadow:0 3px 16px rgba(0,0,0,.25)}
  .card .hd{padding:14px 14px 0;font-weight:600}
  .card .bd{padding:14px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3a63}
  .status-open{color:#fff;background:#2a3a63}
  .status-claimed{color:#111;background:var(--warn)}
  .status-submitted{color:#111;background:var(--good)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap;background:#0e1626;border:1px solid #22314f;border-radius:10px;padding:10px}
  .divider{height:1px;background:#1a2744;margin:8px 0}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Torn Spy Coordinator</h1>
    <p class="sub">Free, single‑file tool for claiming spy targets and submitting standardized results.</p>

    <div class="bar">
      <input id="me" placeholder="Your display name" style="width:220px">
      <input id="api" placeholder="API Base URL (Apps Script)" style="width:420px">
      <input id="key" placeholder="API Key (optional)" style="width:220px">
      <button id="save">Save</button>
      <button id="refresh">Refresh</button>
      <span id="err" class="muted"></span>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="board">Claim Board</button>
      <button class="tab" data-tab="submit">Submit</button>
      <button class="tab" data-tab="manage">Manager</button>
      <button class="tab" data-tab="setup">Setup</button>
    </div>

    <section id="tab-board">
      <div class="card"><div class="hd">Open & Claimed</div><div class="bd">
        <div id="tasks" class="grid cards"></div>
      </div></div>

      <div class="card" style="margin-top:12px"><div class="hd">Recently Submitted</div><div class="bd">
        <div id="recent" class="grid cards"></div>
      </div></div>
    </section>

    <section id="tab-submit" hidden>
      <div class="card"><div class="hd">Submit Spy (Ad‑hoc)</div><div class="bd grid">
        <textarea id="paste" placeholder="Paste any spy text here..."></textarea>
        <div class="mono" id="preview"></div>
        <div class="row">
          <button id="copy">Copy Preview</button>
        </div>
      </div></div>
    </section>

    <section id="tab-manage" hidden>
      <div class="card"><div class="hd">Add Target</div><div class="bd grid">
        <div class="row">
          <input id="m-name" placeholder="Target name (e.g., tc103)" style="flex:1">
          <input id="m-id" placeholder="Target ID (optional)" style="width:180px">
          <input id="m-notes" placeholder="Notes (faction, deadline)" style="flex:1">
          <button id="m-add">Add to Board</button>
        </div>
        <div class="muted">New tasks appear on the board after refresh.</div>
      </div></div>
    </section>

    <section id="tab-setup" hidden>
      <div class="card"><div class="hd">Setup</div><div class="bd">
        <ol>
          <li>Create a Google Sheet tab named <b>Tasks</b> with headers (row 1):<br>
            <span class="mono">id | createdAt | status | targetName | targetId | notes | claimedBy | claimedAt | submittedAt | payloadJson | formatted</span>
          </li>
          <li>Open <b>Extensions → Apps Script</b>. Paste the backend code I provided into <b>Code.gs</b>. Deploy: <b>Deploy → New deployment → Web app</b>. Copy the URL.</li>
          <li>Paste that URL into <b>API Base URL</b> above. (Optional) set a Script property <b>API_KEY</b> and paste the same value here.</li>
        </ol>
        <p class="muted">Host this file anywhere: GitHub Pages, Netlify, or just open it locally in your browser.</p>
      </div></div>
    </section>
  </div>

<script>
// tiny helpers so the page boots without crashing
function qs(s){ return document.querySelector(s); }
var state={tasks:[],me:'',api:'',key:''};
function loadSettings(){
  state.me=localStorage.getItem('torn_employee')||'';
  state.api=localStorage.getItem('torn_api_base')||'';
  state.key=localStorage.getItem('torn_api_key')||'';
  if(qs('#me')) qs('#me').value=state.me;
  if(qs('#api')) qs('#api').value=state.api;
  if(qs('#key')) qs('#key').value=state.key;
}
function saveSettings(){
  state.me=(qs('#me')?.value||'').trim();
  state.api=(qs('#api')?.value||'').trim();
  state.key=(qs('#key')?.value||'').trim();
  localStorage.setItem('torn_employee',state.me);
  localStorage.setItem('torn_api_base',state.api);
  localStorage.setItem('torn_api_key',state.key);
}
async function call(path, method='GET', body){
  if(!state.api) throw new Error('API not configured');
  let url = state.api + path + (path.includes('?') ? (state.key? `&key=${encodeURIComponent(state.key)}`:'') : (state.key? `?key=${encodeURIComponent(state.key)}`:''));
  try{
    const opts={method}; if(body) opts.body=JSON.stringify(body);
    const res=await fetch(url,opts); if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }catch(e){
    if(method!=='GET'){ const qp=encodeURIComponent(JSON.stringify(body||{}));
      const res=await fetch(url+(url.includes('?')?'&':'?')+'payload='+qp+'&_m=get',{method:'GET'});
      if(!res.ok) throw new Error(await res.text()); return await res.json();
    }
    throw e;
  }
}
function render(){ /* minimal no-op so refresh() doesn't crash; replace with full render later */ }
</script>

</body>
</html>