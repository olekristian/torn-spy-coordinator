<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Torn Spy Coordinator</title>
<style>
/* ... same CSS as before ... */
</style>
</head>
<body>
  <div class="wrap">
    <!-- ... same HTML structure as before ... -->
  </div>
<script>
// ===== Utilities, parse functions etc. (same as before) =====

// ... keep all previous code ...

// ===== Actions =====
async function refresh(){
  $('#err').textContent='';
  try{
    const data=await call('?action=list','GET');
    state.tasks=data.tasks||[];
    render();
  }catch(e){
    $('#err').textContent='Refresh failed: '+String(e.message||e);
  }
}

async function claim(id){
  if(!state.me){ alert('Set your display name first.'); return; }
  try{
    await call('', 'POST', {action:'claim', id, employee: state.me});
    await refresh();
  }catch(e){ $('#err').textContent='Claim failed: '+String(e.message||e); }
}

async function unclaim(id){
  try{
    await call('', 'POST', {action:'unclaim', id, employee: state.me});
    await refresh();
  }catch(e){ $('#err').textContent='Unclaim failed: '+String(e.message||e); }
}

async function submitSpy(id){
  if(!state.me){ alert('Set your display name first.'); return; }
  try{
    const ta=document.getElementById(`paste-${id}`);
    const parsed=parseSpy(ta.value||'');
    const payload={ name: parsed.name, targetId: parsed.id, level: parsed.level, strength: parsed.strength, speed: parsed.speed, dexterity: parsed.dexterity, defense: parsed.defense, total: parsed.total, formatted: formatBlock(parsed) };
    await call('', 'POST', {action:'submit', id, employee: state.me, payload});
    ta.value='';
    await refresh();
  }catch(e){ $('#err').textContent='Submit failed: '+String(e.message||e); }
}

async function addTask(){
  const name=document.getElementById('m-name').value.trim();
  const tid=document.getElementById('m-id').value.trim();
  const notes=document.getElementById('m-notes').value.trim();
  if(!name){ alert('Please enter a target name'); return; }
  try{
    await call('', 'POST', {action:'add', targetName:name, targetId:tid, notes});
    document.getElementById('m-name').value='';
    document.getElementById('m-id').value='';
    document.getElementById('m-notes').value='';
    await refresh();
  }catch(e){ $('#err').textContent='Add failed: '+String(e.message||e); }
}

// ===== Event bindings =====

if(document.getElementById('save')) document.getElementById('save').addEventListener('click',()=>{ saveSettings(); refresh(); });
if(document.getElementById('refresh')) document.getElementById('refresh').addEventListener('click',()=>{ refresh(); });
if(document.getElementById('m-add')) document.getElementById('m-add').addEventListener('click',addTask);

// Ad-hoc submit preview
if(document.getElementById('paste')){
  document.getElementById('paste').addEventListener('input',()=>{
    const p=parseSpy(document.getElementById('paste').value||'');
    document.getElementById('preview').textContent=formatBlock(p);
  });
}
if(document.getElementById('copy')){
  document.getElementById('copy').addEventListener('click',()=>{
    navigator.clipboard.writeText(document.getElementById('preview').textContent||'');
  });
}

// Tabs
for(const b of document.querySelectorAll('.tab')){
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const id=b.dataset.tab;
    for(const s of ['board','submit','manage','setup']){
      document.getElementById(`tab-${s}`).hidden = (s!==id);
    }
  });
}

// Init
loadSettings();
refresh();
</script>
</body>
</html>
